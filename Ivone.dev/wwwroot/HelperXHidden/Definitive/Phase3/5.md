# Phase 3.5 — Trust Boundaries And Data Flow

## What To Learn
Sonar enforces trust boundaries at the API level. JWT-authenticated user requests are separate from machine-key authenticated service requests. Each route specifies its trust requirements.

## Why It Exists
Incorrect trust boundaries can expose sensitive pupil data or allow unauthorized operations.

## Where It Lives In The Codebase
- Machine key authentication middleware: `sonar-api/sonar-api/src/Middleware/MachineKeyAuthenticationMiddleware.cs`
- Machine key endpoint filters: `sonar-api/sonar-api/src/Middleware/RequiresMachineKeyEndpointFilters.cs`
- Authenticated user middleware: `sonar-api/sonar-api/src/Program.cs`
- Machine-key protected routes: `sonar-api/sonar-api/src/Areas/*/*Routes.cs`

## Trust Boundary Types
1. **User Requests (JWT)**
   - Normal UI requests authenticated by JWT.
   - Scoped by school context.

2. **Machine Requests (MachineKey)**
   - Service-to-service calls using `MachineKey` headers.
   - Used for queue runners and data preparation.

## Examples Of Machine-Key Protected Routes
- Data preparation routes: `sonar-api/sonar-api/src/Areas/DataPreparation/DataPreparationRoutes.cs`
- Wonde sync routes: `sonar-api/sonar-api/src/Areas/Wonde/WondeRoutes.cs`
- Observation sync routes: `sonar-api/sonar-api/src/Areas/Observation/ObservationRoutes.cs`

## Questions And Answers
- **Which endpoints require machine keys?**
  - Any route marked with `.RequiresMachineKey(...)` in its route builder. These include data preparation, Wonde sync, and some observation endpoints.

- **Where are JWT claims interpreted?**
  - JWT claims are parsed by auth middleware and used to populate `IAuthenticatedUser` in `sonar-api/sonar-api/src/Program.cs`.

## Additional Questions You Should Be Able To Answer
- Why does machine-key authentication bypass some permission checks?
  - Machine-key endpoints are trusted system-level operations and are guarded by separate authentication and route-level checks.

- How can you verify a route’s trust boundary quickly?
  - Inspect the route definition and look for `.RequiresMachineKey(...)` or permission-based endpoint filters.

## Completion Check
You can identify trust boundary types, list machine-key protected routes, and explain how JWT and machine-key authentication differ.
