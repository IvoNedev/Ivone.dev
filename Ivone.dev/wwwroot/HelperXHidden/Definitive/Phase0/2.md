# Phase 0.2 — Who Uses Sonar (Roles, Permissions, Personas)

## What To Learn
The Sonar platform serves multiple user personas with different data access needs. Permissions are enforced at the API layer using endpoint filters and role/permission entities.

## Why It Exists
School data is sensitive, and UK education workflows differ by role. A classroom teacher should see different views and controls than a senior leader or system administrator.

## Where It Lives In The Codebase
- Role and permission entities: `sonar-api/sonar-data/Entity` (e.g., `RoleEntity`, `RolePermissionEntity`, `UserInRoleEntity`)
- Authenticated user context: `sonar-api/sonar-api/src/Middleware/*`, `sonar-api/sonar-api/src/Program.cs`
- Permission filters: `sonar-api/sonar-api/src/Middleware/RequiresPermissionEndpointFilters.cs`

## Core Personas And Their Typical Capabilities
- **Teacher**
  - Enter assessments and observations.
  - View class-level and pupil-level reports.
  - Operates within a single school context.
- **Senior Leadership**
  - Access cohort and school-wide summaries.
  - Review gaps, attainment, and progress trends.
  - Uses PDF outputs for governance and accountability.
- **School Admin**
  - Manage access and configuration.
  - Perform setup tasks that influence data structure (subjects, groups).
- **System Operator**
  - Maintains integration pipelines and background jobs.
  - Uses machine-key routes for service orchestration.

## How Permissions Are Enforced
- Permissions are evaluated by endpoint filters during request processing.
- The `IAuthenticatedUser` is populated by middleware in `sonar-api/sonar-api/src/Program.cs`.
- Filters validate whether the request has the required permission or feature access.

## Where Roles Are Applied In Code
- The user identity and claims are read in `sonar-api/sonar-api/src/Program.cs` and `sonar-api/sonar-api/src/Middleware/*`.
- Permission enforcement appears in route definitions and endpoint filters.

## Questions And Answers
- **Which roles are system-level vs school-level?**
  - System-level roles are typically those used by platform admins and operators. School-level roles map to teacher/leadership/admin roles tied to a school context.

- **Where are permissions enforced (filters vs handlers vs DB)?**
  - Enforcement happens primarily in endpoint filters, before handlers run. The database holds role/permission data but does not enforce access directly.

- **Which endpoints are machine-to-machine only?**
  - Machine-to-machine endpoints are protected by machine keys configured in `sonar-api/sonar-api/src/Program.cs` and middleware. Look for routes that are used by runners (e.g., data preparation or sync triggers).

## Additional Questions You Should Be Able To Answer
- How is the current school context resolved?
  - The authenticated user context provides `CurrentSchoolId`, derived from the request identity.

- Why are endpoint filters preferable to handler-level checks?
  - Filters enforce a consistent security boundary before business logic runs, reducing accidental data exposure.

## Completion Check
You can describe the platform’s main personas, list where role/permission entities live, and explain how endpoint filters enforce access.
