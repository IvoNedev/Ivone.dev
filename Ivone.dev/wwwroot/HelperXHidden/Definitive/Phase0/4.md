# Phase 0.4 â€” High-Level Mental Model Of The System

## What To Learn
The Sonar system is a multi-repo platform with frontends, an API, and background services. Requests flow from UI to API to data stores, with async processing for heavy tasks.

## Why It Exists
Without a clear request/processing model, changes can break cross-service contracts or degrade performance.

## Where It Lives In The Codebase
- API entry: `sonar-api/sonar-api/src/Program.cs`
- Route registration: `sonar-api/sonar-api/src/RoutesRegistration.cs`
- Reports UI PDF pipeline: `sonar/reports-web/src/app/component/common/DownloadButton.tsx`
- Queue registration: `sonar-api/sonar-api/src/Infrastructure/Queue/QueueRegistration.cs`

## Data Flow (Typical Report Request)
1. User selects filters in Reports Web (`sonar/reports-web`).
2. UI builds report parameters and calls an API endpoint (`sonar-api/sonar-api/src/Areas/Reports/*`).
3. API retrieves data via entities or stored procedures.
4. Reports Web renders chart/table outputs.
5. If PDF is requested, Reports Web captures HTML and posts to `/reportpdf` (handled by API).
6. Document generation returns a PDF.

## Synchronous vs Asynchronous Work
- **Synchronous**: Most report data queries, validation, and filtering.
- **Asynchronous**: Data preparation jobs, large batch processing, external data syncs.

## Questions And Answers
- **Which operations are synchronous vs queued?**
  - Synchronous: direct report requests, assessment retrieval, UI-driven queries.
  - Queued: data preparation/analysis and integration tasks; these run in `sonar-queue-*` services.

- **Which services own HTML-to-PDF generation?**
  - Reports Web assembles HTML; Sonar API receives it via `/reportpdf` and routes it to document generation.

## Additional Questions You Should Be Able To Answer
- Where does authentication happen in the request flow?
  - JWT auth is enforced in `sonar-api/sonar-api/src/Program.cs` via middleware and endpoint filters.

- Where does the system enforce CORS?
  - CORS policies are configured in `sonar-api/sonar-api/src/Program.cs`.

## Completion Check
You can explain the system request flow, identify synchronous vs queued operations, and point to the files that configure those boundaries.
